{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Header -->
    <div class="chat-header">
        <h2>AI Chatbot</h2>
        <div class="suggestions">
            <strong style="margin-right:8px;">Try asking about:</strong>
            <button class="faq-btn" data-msg="hours">Hours</button>
            <button class="faq-btn" data-msg="pricing">Pricing</button>
            <button class="faq-btn" data-msg="signup">Signup</button>
            <button class="faq-btn" data-msg="features">Features</button>
            <button class="faq-btn" data-msg="contact">Contact</button>
        </div>
    </div>

    <!-- Chat messages -->
    <div class="chat-messages" id="chat-messages">
        <!-- messages will be dynamically appended -->
    </div>

    <!-- Input -->
    <div class="chat-input">
        <input type="text" id="user-input" placeholder="Type a message..." autocomplete="off">
        <button id="send-btn">Send</button>
        <button id="request-human" type="button">Request Human</button>
    </div>
</div>

<script>
const chatMessages = document.getElementById("chat-messages");
const userInput = document.getElementById("user-input");
const sendBtn = document.getElementById("send-btn");
const requestHumanBtn = document.getElementById("request-human");
const faqBtns = document.querySelectorAll(".faq-btn");

// Auto scroll to bottom
function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Add message to chat
function addMessage(role, text, timestamp=null) {
    const el = document.createElement("div");
    el.className = `message ${role === 'user' ? 'user' : 'bot'}`;
    el.innerHTML = text;
    if (timestamp) {
        const t = document.createElement('span');
        t.className = 'msg-time';
        t.textContent = new Date(timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        el.appendChild(t);
    }
    chatMessages.appendChild(el);
    scrollToBottom();
}

// Format markdown/basic links
function formatMessage(text) {
    if (!text) return '';
    return text
        .replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>');
}

// Typing animation for bot
function typeBotMessage(message) {
    const formattedMessage = formatMessage(message);
    const msgDiv = document.createElement("div");
    msgDiv.className = "message bot";
    chatMessages.appendChild(msgDiv);
    scrollToBottom();

    let i = 0;
    function typeNext() {
        if (i >= formattedMessage.length) return;

        if (formattedMessage[i] === '<') {
            const endTag = formattedMessage.indexOf('>', i);
            if (endTag !== -1) {
                msgDiv.innerHTML += formattedMessage.slice(i, endTag + 1);
                i = endTag + 1;
            } else {
                msgDiv.innerHTML += formattedMessage[i];
                i++;
            }
        } else {
            msgDiv.innerHTML += formattedMessage[i];
            i++;
        }
        scrollToBottom();
        setTimeout(typeNext, 25);
    }
    typeNext();
}

// Load existing chat history
async function loadChatHistory() {
    try {
        const res = await fetch("/chat/history");
        const messages = await res.json();
        chatMessages.innerHTML = "";
        messages.forEach(msg => {
            if (msg.sender === "bot") {
                typeBotMessage(msg.text); // animate bot messages
            } else {
                addMessage("user", msg.text, msg.timestamp);
            }
        });
        scrollToBottom();
    } catch (err) {
        console.error("Failed to load chat history", err);
    }
}

loadChatHistory(); // call immediately on page load

// Send message to server
async function sendMessage(text) {
    addMessage('user', formatMessage(text));

    const typingIndicator = document.createElement("div");
    typingIndicator.className = "message bot typing-indicator";
    typingIndicator.innerHTML = "<span></span><span></span><span></span>";
    chatMessages.appendChild(typingIndicator);
    scrollToBottom();

    const startTime = Date.now();
    try {
        const res = await fetch("/chat", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ message: text })
        });
        const data = await res.json();

        const minTypingTime = 500;
        const elapsed = Date.now() - startTime;
        if (elapsed < minTypingTime) await new Promise(r => setTimeout(r, minTypingTime - elapsed));

        typingIndicator.remove();
        if (data && data.reply) typeBotMessage(data.reply);
        else addMessage('bot', '⚠️ No response from server.');
    } catch (err) {
        typingIndicator.remove();
        addMessage('bot', '⚠️ Error contacting server.');
        console.error(err);
    }
}

// Event listeners
sendBtn.addEventListener('click', () => {
    const text = userInput.value.trim();
    if (!text) return;
    userInput.value = '';
    sendMessage(text);
});
userInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') {
        e.preventDefault();
        sendBtn.click();
    }
});
requestHumanBtn.addEventListener('click', () => sendMessage('Request Human'));
faqBtns.forEach(btn => {
    btn.addEventListener('click', () => sendMessage(btn.dataset.msg));
});
</script>
{% endblock %}
