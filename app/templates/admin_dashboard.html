{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="admin-container">
    <h2>Admin Dashboard - Human Requests</h2>
    <div class="requests-wrapper">
        <ul id="requests-list"></ul>
    </div>
</div>

<script>
const requestsList = document.getElementById("requests-list");

function formatTimestamp(isoString) {
    const date = new Date(isoString);
    return date.toLocaleString([], { 
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit' 
    });
}

async function loadHumanRequests() {
    try {
        const res = await fetch("/admin/requests");
        const requests = await res.json();
        requestsList.innerHTML = "";

        if (requests.length === 0) {
            requestsList.innerHTML = "<li class='no-requests'>No pending human requests.</li>";
            return;
        }

        requests.forEach(r => {
            const li = document.createElement("li");
            li.classList.add("request-item");
            li.style.opacity = 0;
            li.style.transform = "translateY(-10px)";
            li.innerHTML = `
                <span>
                    <strong>${r.user}</strong>: "${r.text}"
                    <span class="msg-time">(${formatTimestamp(r.timestamp)})</span>
                </span>
                <button class="btn handle-btn">Mark Handled</button>
            `;

            const handleBtn = li.querySelector("button");
            handleBtn.addEventListener("click", async () => {
                handleBtn.disabled = true;
                try {
                    const res = await fetch(`/admin/requests/${r.id}/handle`, { method: "POST" });
                    const data = await res.json();
                    if (data.status === "success") li.remove();
                    else throw new Error("Failed to mark handled");
                } catch (err) {
                    alert("Failed to mark as handled");
                    console.error(err);
                    handleBtn.disabled = false;
                }
            });

            requestsList.appendChild(li);

            setTimeout(() => {
                li.style.transition = "all 0.3s ease";
                li.style.opacity = 1;
                li.style.transform = "translateY(0)";
            }, 50);
        });
    } catch (err) {
        console.error("Failed to load requests", err);
    }
}

loadHumanRequests();
setInterval(loadHumanRequests, 10000);
</script>
{% endblock %}
